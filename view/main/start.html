<!DOCTYPE html>
<html>
<head>
	<title>WikiFacts</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="../dist/leaflet.css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />

	<!--[if lte IE 8]><link rel="stylesheet" href="../dist/leaflet.ie.css" /><![endif]-->
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script>
		function checkNewThings(){
			hfx.geoNear(usersPosition[0],usersPosition[1],50,function(data){
				var items = data["_items"];
				for (var i = items.length - 1; i >= 0; i--) {
					var meta = items[i]["meta"];
					var item_position = [items[i]["latitude"],items[i]["longitude"]];
					
					var myIcon = L.icon({
					    iconUrl: 'images/bus.png',
					});
					L.marker(item_position, {icon: myIcon}).addTo(map)
						.bindPopup("<b>"+meta["LOCATION"]+"</b><br/><br/>").openPopup();

				};
			},{'type':'bus_stops'});


			hfx.geoNear(usersPosition[0],usersPosition[1],50,function(data){
				var items = data["_items"];
				console.log(data);
				for (var i = items.length - 1; i >= 0; i--) {
					var meta = items[i]["meta"];
					var item_position = [items[i]["latitude"],items[i]["longitude"]];
					
					var myIcon = L.icon({
					    iconUrl: 'images/bus.png',
					});
					L.marker(item_position, {icon: myIcon}).addTo(map)
						.bindPopup("<b>"+meta["LOCATION"]+"</b><br/><br/>").openPopup();

				};
			},{'type':'trails'});
		}
		$(document).ready(function() {
			$( ".comment_box" ).each(function (i) {
				$(this).height($(this).parent().height()-$(this).next(".current_comment").height()-25);
	      		//setInterval ( "checkNewThings()", 10000 );
	      		checkNewThings();

	      	});
		});
	</script>

	<script>
		if ( navigator.geolocation ) {
			function success(pos) {
				// Location found, show map with these coordinates
				console.log([pos.coords.latitude, pos.coords.longitude]);
			}
			
			function pressRate(element){
				$(".ratepanel").show();
				$(".current_comment").hide();
			}

			function fail(error) {
				
			}
			
			// Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
			navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
		}
	</script>

	<!-- RESTful API -->
	<script src="../dist/hfx.js"></script>

</head>
<body>


	<div id="main">

<div data-role="page">

	<div data-role="content">
	</div><!-- /content -->

 	<div data-role="panel" data-display="overlay" id="your-location-panel" data-theme="b">

		<div class="ratepanel" style="display:none">
 			<div data-role="fieldcontain">
				<label for="slider">Service</label><br/>
					<div data-role="fieldcontain">
					    <fieldset data-role="controlgroup">
					    	<legend>Like this location:</legend>
					         	<input type="radio" name="radio-choice-1" id="radio-choice-1" value="choice-1" checked="checked" />
					         	<label for="radio-choice-1">Yes</label>

					         	<input type="radio" name="radio-choice-1" id="radio-choice-2" value="choice-2"  />
					         	<label for="radio-choice-2">No</label>

					    </fieldset>
					</div>
			</div>
 			<br/> 
 		</div>

		<div class="comment_box" style="height:390px;font:16px/26px Georgia, Garamond, Serif;overflow:auto;">
		
		</div>
		<div class="current_comment">
        <textarea></textarea> 
 		<button>Comment</button>
 		<button data-theme="a">Snap Picture</button>
 		<button data-theme="a" onclick="pressRate(this)">Rate This</button>
 		</div>
<!--         <a href="#" data-rel="close" data-role="button" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">Close</a> -->
    </div><!-- /panel -->

 	<div data-role="panel" data-display="overlay" id="trending-panel" data-theme="b">
		<div class="comment_box" style="height:500px;font:16px/26px Georgia, Garamond, Serif;overflow:auto;">
		Said: new
		</div>
		<div class="current_comment">
        <textarea></textarea> 
 		<button>Comment</button>
 		<button data-theme="a">Snap Picture</button>
 		</div>
<!--         <a href="#" data-rel="close" data-role="button" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">Close</a> -->
    </div><!-- /panel -->

 	<div data-role="panel" data-display="overlay" id="friends-panel" data-theme="b">
 		<h1>Friend Activity</h1>

		<div class="comment_box" style="height:500px;font:16px/26px Georgia, Garamond, Serif;overflow:auto;">
		things
		</div>
		<div class="current_comment">
        <textarea></textarea> 
 		<button>Comment</button>
 		<button data-theme="a">Snap Picture</button>
 		</div>
<!--         <a href="#" data-rel="close" data-role="button" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">Close</a> -->
    </div><!-- /panel -->

 	<div data-role="panel" data-display="overlay" id="nearby-panel" data-theme="b">
		<div class="comment_box" style="height:500px;font:16px/26px Georgia, Garamond, Serif;overflow:auto;">
		
		</div>
		<div class="current_comment">
        <textarea></textarea> 
 		<button>Comment</button>
 		<button data-theme="a">Snap Picture</button>
 		</div>
<!--         <a href="#" data-rel="close" data-role="button" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">Close</a> -->
    </div><!-- /panel -->

	<div data-role="header" data-id="foo1" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#your-location-panel" data-shadow="false" data-iconshadow="false" class="ui-icon-nodisc">Your Location</a></li>
				<li><a href="#trending-panel" data-shadow="false" data-iconshadow="false" class="ui-icon-nodisc">Trending</a></li>
				<li><a href="#friends-panel" data-shadow="false" data-iconshadow="false" class="ui-icon-nodisc">Friends</a></li>
				<li><a href="#nearby-panel" data-shadow="false" data-iconshadow="false" class="ui-icon-nodisc">Search</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /footer -->

</div><!-- /page -->

		<a href="#" onclick="showMap()">Click here</a>


	</div>

		<div id="map" style="width: 100%; height: 100%"></div>

	</div>

	<script>
		usersPosition = [44.64844, -63.57582];

		function getLocation()
		  {
		  if (navigator.geolocation)
		    {
		    navigator.geolocation.getCurrentPosition(showPosition);
		    }
		  }
		 function showPosition(position)
		  {
		  		usersPosition = [position.coords.latitude, position.coords.longitude];
		  }

	</script>

	<script src="../dist/leaflet.js"></script>
	<script>

		console.log(usersPosition);
		var map = L.map('map').setView(usersPosition, 13);

		L.tileLayer('http://a.tiles.mapbox.com/v3/oogalaboogala.map-eh6b4ikh/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: ''
		}).addTo(map);


		L.marker(usersPosition).addTo(map)
			.bindPopup("Recent Updates<br/>More..").openPopup();

		L.circle(usersPosition, 500, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map).bindPopup("I am a circle.");

		var popup = L.popup();

		function onMapClick(e) {
			
			console.log('Mapclick', e.latlng);

			hfx.geoNear(e.latlng.lat, e.latlng.lng, 0.001, function(data) { 

				console.log(data); 

			popup
				.setLatLng(e.latlng)
				.setContent(JSON.stringify(data) )
				.openOn(map);

			});

		}

		map.on('click', onMapClick);
	</script>


</body>
</html>
